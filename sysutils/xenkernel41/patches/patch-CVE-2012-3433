$NetBSD: patch-CVE-2012-3433,v 1.1 2012/08/10 09:59:47 drochner Exp $

see http://lists.xen.org/archives/html/xen-devel/2012-08/msg00855.html

--- xen/arch/x86/mm/p2m.c.orig	2011-10-20 17:05:48.000000000 +0000
+++ xen/arch/x86/mm/p2m.c
@@ -2043,6 +2043,8 @@ void p2m_teardown(struct p2m_domain *p2m
 #ifdef __x86_64__
     for ( gfn=0; gfn < p2m->max_mapped_pfn; gfn++ )
     {
+	if ( atomic_read(&d->shr_pages) == 0 )
+	    break;
         mfn = p2m->get_entry(p2m, gfn, &t, &a, p2m_query);
         if ( mfn_valid(mfn) && (t == p2m_ram_shared) )
             BUG_ON(mem_sharing_unshare_page(p2m, gfn, MEM_SHARING_DESTROY_GFN));
